<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relatório Financeiro Mensal</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2064%2064%22%3E%0A%3Cdefs%3E%3ClinearGradient%20id%3D%22bg%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%3Cstop%20offset%3D%220%22%20stop-color%3D%22%230b1020%22/%3E%3Cstop%20offset%3D%221%22%20stop-color%3D%22%23121a33%22/%3E%3C/linearGradient%3E%3C/defs%3E%0A%3Crect%20width%3D%2264%22%20height%3D%2264%22%20rx%3D%2214%22%20fill%3D%22url%28%23bg%29%22/%3E%0A%3Crect%20x%3D%2214%22%20y%3D%2230%22%20width%3D%228%22%20height%3D%2220%22%20rx%3D%223%22%20fill%3D%22%232ee59d%22/%3E%0A%3Crect%20x%3D%2228%22%20y%3D%2220%22%20width%3D%228%22%20height%3D%2230%22%20rx%3D%223%22%20fill%3D%22%23ff8da1%22/%3E%0A%3Crect%20x%3D%2242%22%20y%3D%2226%22%20width%3D%228%22%20height%3D%2224%22%20rx%3D%223%22%20fill%3D%22%23f6c945%22/%3E%0A%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2064%2064%22%3E%0A%3Cdefs%3E%3ClinearGradient%20id%3D%22bg%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%3Cstop%20offset%3D%220%22%20stop-color%3D%22%230b1020%22/%3E%3Cstop%20offset%3D%221%22%20stop-color%3D%22%23121a33%22/%3E%3C/linearGradient%3E%3C/defs%3E%0A%3Crect%20width%3D%2264%22%20height%3D%2264%22%20rx%3D%2214%22%20fill%3D%22url%28%23bg%29%22/%3E%0A%3Crect%20x%3D%2214%22%20y%3D%2230%22%20width%3D%228%22%20height%3D%2220%22%20rx%3D%223%22%20fill%3D%22%232ee59d%22/%3E%0A%3Crect%20x%3D%2228%22%20y%3D%2220%22%20width%3D%228%22%20height%3D%2230%22%20rx%3D%223%22%20fill%3D%22%23ff8da1%22/%3E%0A%3Crect%20x%3D%2242%22%20y%3D%2226%22%20width%3D%228%22%20height%3D%2224%22%20rx%3D%223%22%20fill%3D%22%23f6c945%22/%3E%0A%3C/svg%3E">
  <meta name="theme-color" content="#0b1020">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg0:#070b14;
      --bg1:#0b1222;
      --card:rgba(255,255,255,.035);
      --line:rgba(112,146,255,.18);
      --text:#e8eefc;
      --muted:rgba(232,238,252,.72);
      --muted2:rgba(232,238,252,.55);
      --good:#2ee59d;
      --warn:#f6c945;
      --bad:#ff5c79;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 25% 10%, rgba(59,130,246,.22), transparent 60%),
        radial-gradient(900px 650px at 85% 40%, rgba(147,51,234,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .container{ max-width: 1260px; margin: 0 auto; padding: 28px 18px 60px; }
    header{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:16px; margin-bottom: 18px;
    }
    h1{ margin:0; font-size: 26px; letter-spacing:.2px; }
    .sub{ margin-top: 6px; color: var(--muted); font-size: 13px; max-width: 760px; line-height: 1.45; }
    .controls{ display:flex; gap:10px; align-items:center; }
    .btn{
      appearance:none; border:1px solid rgba(120,150,255,.25);
      background: rgba(20,35,64,.65);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
      font-weight: 700;
      font-size: 13px;
    }
    .btn:hover{ border-color: rgba(120,150,255,.40); }

    .grid{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap: 18px;
      align-items:start;
    }

    .card{position:relative;
      
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
      border: 1px solid rgba(120,150,255,.16);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h2{
      margin:0 0 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing:.2px;
      text-transform: uppercase;
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 12px;
    }
    .kpi{
      background: rgba(10,18,34,.35);
      border: 1px solid rgba(120,150,255,.14);
      border-radius: 14px;
      padding: 12px 12px 10px;
      min-height: 86px;
    }
    .kpi .name{ font-size: 12px; color: var(--muted); margin-bottom: 8px; font-weight:800; }
    .kpi .value{ font-size: 18px; font-weight: 900; letter-spacing:.1px; }
    .kpi .hint{ font-size: 13px; font-weight: 800; color: var(--muted2); margin-top: 6px; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      font-size: 12px;
      color: var(--text);
      background: rgba(12,22,42,.55);
      border: 1px solid rgba(120,150,255,.14);
      border-radius: 999px;
      padding: 7px 10px;
      width: fit-content;
      margin-bottom: 10px;
    }
    .dot{ width: 8px; height: 8px; border-radius: 50%; display:inline-block; }
    .dot.good{ background: var(--good); }
    .dot.warn{ background: var(--warn); }
    .dot.bad{ background: var(--bad); }

    .chartsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .canvasWrap{
      height: 340px;
      background: rgba(6,12,24,.20);
      border: 1px solid rgba(120,150,255,.10);
      border-radius: 14px;
      padding: 10px;
      position: relative;
      overflow: hidden;
    }
    .canvasWrap.large{ height: 420px; }
    .canvasWrap.tall{ height: 360px; }

    canvas{ width: 100% !important; height: 100% !important; }

    .canvasPlaceholder{
      position:absolute; inset:10px;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      color: rgba(232,238,252,.72);
      border: 1px dashed rgba(120,150,255,.18);
      border-radius: 12px;
      padding: 16px;
      pointer-events:none;
      backdrop-filter: blur(1px);
    }

    .alert{
      border-radius: 14px;
      border: 1px solid rgba(120,150,255,.14);
      background: rgba(10,18,34,.55);
      padding: 12px;
    }
    .alert .t{ font-weight:900; margin-bottom:6px; }
    .alert .s{ color: var(--muted); font-size: 12px; line-height:1.35; }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td{
      padding: 10px 8px;
      border-bottom: 1px solid rgba(120,150,255,.10);
      text-align:left;
      vertical-align: middle;
      white-space: nowrap;
    }
    th{
      color: var(--muted);
      font-weight: 900;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing:.2px;
    }
    td.r, th.r{ text-align:right; }
    .scroll{
      max-height: 340px;
      overflow:auto;
      border: 1px solid rgba(120,150,255,.10);
      border-radius: 14px;
      background: rgba(6,12,24,.15);
    }
    .muted{ color: var(--muted); }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .chartsGrid{ grid-template-columns: 1fr; }
      .canvasWrap{ height: 320px; }
      .canvasWrap.tall{ height: 340px; }
    }
  
  .ccTimelines{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap:16px;
    margin-top:12px;
  }
  @media (max-width: 900px){
    .ccTimelines{ grid-template-columns: 1fr; }
  }
  .ccCard{
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 16px;
    padding: 12px;
  }
  .ccCard .ccTitle{
    display:flex;
    gap:10px;
    align-items:center;
    margin:0 0 10px;
    font-weight:600;
  }
  .ccCard .ccTitle span{
    opacity:.85;
    font-weight:500;
  }


    .pillRow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .pillTitle{display:flex;align-items:center;gap:10px;min-width:0}
        .h2row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .h2row h2{margin:0}
    
    .h2row .pill .infoBtn{margin-left:10px}
    .infoBtn{margin-left:12px;margin-right:6px}
.infoBtn{width:26px;height:26px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background:rgba(12,18,34,.35);color:rgba(232,238,252,.88);font-weight:800;cursor:pointer;flex:0 0 auto}
    /* Posiciona o botão de informação no canto do card (somente nos cards marcados) */
    .cardCornerInfo .h2row{padding-right:38px;}
    .cardCornerInfo .infoBtn{position:absolute;top:-12px;right:12px;margin:0;}

    .infoBtn:hover{border-color:rgba(255,255,255,.22)}
    .infoBtn:active{transform:translateY(1px)}
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
    .modal{width:min(720px,100%);background:rgba(10,14,26,.98);border:1px solid rgba(255,255,255,.12);
      border-radius:18px;box-shadow:0 18px 60px rgba(0,0,0,.55);overflow:hidden}
    .modalHd{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10)}
    .modalHd .t{font-weight:800}
    .modalBd{padding:14px 16px;color:rgba(232,238,252,.90);line-height:1.5;text-align:justify;hyphens:auto}
    .modalBd b{color:#fff}
    .modalBd ul{margin:10px 0 0 18px;padding:0}
    .modalBd li{margin:6px 0}
    .modalClose{width:34px;height:34px;border-radius:10px;border:1px solid rgba(255,255,255,.14);
      background:rgba(12,18,34,.35);color:rgba(232,238,252,.88);cursor:pointer}

  
    .h2row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .h2row 

    
    /* posicionar o info dos headers (KPIs/Alertas) no canto superior direito do card */
    .card{position:relative}
    .card .h2row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .card .h2row .infoBtn{
      position:absolute;
      right:16px;
      top:10px;
      transform:none;
      margin:0;
    }

  </style>
<script>
window.REPORT_DATA = {"meta":{"companyName":"Sonder","monthKey":"2025-12","monthLabel":"Dez/2025","currency":"BRL","generatedAtISO":"2025-12-31T19:07:47.262Z"},"kpis":{"contasPagas":25174,"contasRecebidas":25193.02,"variacaoCaixa":19.02,"receitaOperacional":13023.1,"custoOperacional":628.89,"despesaOperacional":14314.06,"margemContribuicao":12394.21,"atividadeInvestimento":-729.06,"atividadeFinanciamento":2667.93,"resultadoOperacional":-1919.85,"variacaoCaixaDEF":19.02},"comparisonRealizado":[{"month":"2025-08","label":"Ago/2025","contasPagas":25021.51,"contasRecebidas":25448.11,"variacaoCaixa":426.6},{"month":"2025-09","label":"Set/2025","contasPagas":29690.81,"contasRecebidas":29227.7,"variacaoCaixa":-463.11},{"month":"2025-10","label":"Out/2025","contasPagas":24868.54,"contasRecebidas":25044.59,"variacaoCaixa":176.05},{"month":"2025-11","label":"Nov/2025","contasPagas":31687.1,"contasRecebidas":31793.35,"variacaoCaixa":106.25},{"month":"2025-12","label":"Dez/2025","contasPagas":25174,"contasRecebidas":25193.02,"variacaoCaixa":19.02}],"comparisonOperacao":[{"month":"2025-08","label":"Ago/2025","receitaOperacional":11073.96,"custoOperacional":800.96,"despesaOperacional":14448.38,"margemContribuicao":10273,"atividadeInvestimento":-1004.34,"atividadeFinanciamento":5606.32,"resultadoOperacional":-4175.38,"variacaoCaixaDEF":426.6},{"month":"2025-09","label":"Set/2025","receitaOperacional":13666.7,"custoOperacional":2085.72,"despesaOperacional":12775.88,"margemContribuicao":11580.98,"atividadeInvestimento":-99.85,"atividadeFinanciamento":831.64,"resultadoOperacional":-1194.9,"variacaoCaixaDEF":-463.11},{"month":"2025-10","label":"Out/2025","receitaOperacional":14338.53,"custoOperacional":246.58,"despesaOperacional":13307.36,"margemContribuicao":14091.95,"atividadeInvestimento":-450.34,"atividadeFinanciamento":-158.2,"resultadoOperacional":784.59,"variacaoCaixaDEF":176.05},{"month":"2025-11","label":"Nov/2025","receitaOperacional":13441.36,"custoOperacional":-681.92,"despesaOperacional":17107.48,"margemContribuicao":14123.28,"atividadeInvestimento":-1163.57,"atividadeFinanciamento":4254.02,"resultadoOperacional":-2984.2,"variacaoCaixaDEF":106.25},{"month":"2025-12","label":"Dez/2025","receitaOperacional":13023.1,"custoOperacional":628.89,"despesaOperacional":14314.06,"margemContribuicao":12394.21,"atividadeInvestimento":-729.06,"atividadeFinanciamento":2667.93,"resultadoOperacional":-1919.85,"variacaoCaixaDEF":19.02}],"cashflowDaily":[{"date":"2025-12-01","entradas":995.23,"saidas":995.23,"variacao":0},{"date":"2025-12-02","entradas":0,"saidas":0,"variacao":0},{"date":"2025-12-03","entradas":235.52,"saidas":180,"variacao":55.52},{"date":"2025-12-04","entradas":0,"saidas":38.94,"variacao":-38.94},{"date":"2025-12-05","entradas":1400,"saidas":1407.5,"variacao":-7.5},{"date":"2025-12-06","entradas":0,"saidas":0,"variacao":0},{"date":"2025-12-07","entradas":0,"saidas":0,"variacao":0},{"date":"2025-12-08","entradas":0,"saidas":0,"variacao":0},{"date":"2025-12-09","entradas":5435.12,"saidas":109.82,"variacao":5325.3},{"date":"2025-12-10","entradas":898.4,"saidas":6144.78,"variacao":-5246.38},{"date":"2025-12-11","entradas":100,"saidas":136.6,"variacao":-36.6},{"date":"2025-12-12","entradas":5000,"saidas":3542.23,"variacao":1457.77},{"date":"2025-12-13","entradas":0,"saidas":139.73,"variacao":-139.73},{"date":"2025-12-14","entradas":0,"saidas":132.02,"variacao":-132.02},{"date":"2025-12-15","entradas":3950,"saidas":4541.54,"variacao":-591.54},{"date":"2025-12-16","entradas":0,"saidas":61.78,"variacao":-61.78},{"date":"2025-12-17","entradas":0,"saidas":136.25,"variacao":-136.25},{"date":"2025-12-18","entradas":1345.83,"saidas":1563.65,"variacao":-217.82},{"date":"2025-12-19","entradas":4381,"saidas":1819.43,"variacao":2561.57},{"date":"2025-12-20","entradas":0,"saidas":102.26,"variacao":-102.26},{"date":"2025-12-21","entradas":350,"saidas":1489.9,"variacao":-1139.9},{"date":"2025-12-22","entradas":170,"saidas":1717.27,"variacao":-1547.27},{"date":"2025-12-23","entradas":931.92,"saidas":783.9,"variacao":148.02},{"date":"2025-12-24","entradas":0,"saidas":109.17,"variacao":-109.17},{"date":"2025-12-25","entradas":0,"saidas":0,"variacao":0},{"date":"2025-12-26","entradas":0,"saidas":0,"variacao":0},{"date":"2025-12-27","entradas":0,"saidas":22,"variacao":-22},{"date":"2025-12-28","entradas":0,"saidas":0,"variacao":0},{"date":"2025-12-29","entradas":0,"saidas":0,"variacao":0},{"date":"2025-12-30","entradas":0,"saidas":0,"variacao":0},{"date":"2025-12-31","entradas":0,"saidas":0,"variacao":0}],"forecastRealizacao":{"contasAPagar":13507.44,"contasAReceber":9856.39,"variacaoCaixa":-3651.05},"forecastOperacao":{"receitaOperacional":9856.39,"custoOperacional":2023.54,"despesaOperacional":6087.47,"margemContribuicao":7832.85,"atividadeInvestimento":-778.54,"atividadeFinanciamento":-4617.89,"resultadoOperacional":1745.38,"variacaoCaixaDEF":-3651.05},"costCenters":{"resultadoOperacional":[{"name":"Consultoria","value":2446.92},{"name":"Tecnologia","value":1294.11},{"name":"Fotografia","value":350},{"name":"Odontologia","value":-1061.7},{"name":"Sem centro de custo","value":-1064.98},{"name":"Pessoal","value":-3884.2}],"receitaOperacional":[{"name":"Pessoal","value":6430.35},{"name":"Consultoria","value":2946.92},{"name":"Tecnologia","value":2650},{"name":"Odontologia","value":645.83},{"name":"Fotografia","value":350},{"name":"Sem centro de custo","value":0}],"custoOperacional":[{"name":"Pessoal","value":312.99},{"name":"Odontologia","value":197.64},{"name":"Tecnologia","value":119.59},{"name":"Consultoria","value":0},{"name":"Fotografia","value":0},{"name":"Sem centro de custo","value":-1.33}],"despesaOperacional":[{"name":"Pessoal","value":10001.56},{"name":"Odontologia","value":1509.89},{"name":"Tecnologia","value":1236.3},{"name":"Sem centro de custo","value":1066.31},{"name":"Consultoria","value":500},{"name":"Fotografia","value":0}],"monthBreakdown":[{"name":"Consultoria","receita":2946.92,"custo":0,"despesa":500,"resultado":2446.92},{"name":"Tecnologia","receita":2650,"custo":119.59,"despesa":1236.3,"resultado":1294.11},{"name":"Fotografia","receita":350,"custo":0,"despesa":0,"resultado":350},{"name":"Odontologia","receita":645.83,"custo":197.64,"despesa":1509.89,"resultado":-1061.7},{"name":"Sem centro de custo","receita":0,"custo":-1.33,"despesa":1066.31,"resultado":-1064.98},{"name":"Pessoal","receita":6430.35,"custo":312.99,"despesa":10001.56,"resultado":-3884.2}],"monthly":[{"month":"2025-08","label":"Ago/2025","items":[{"name":"Consultoria","receita":2165,"custo":-45,"despesa":600,"resultado":1610},{"name":"Fotografia","receita":0,"custo":0,"despesa":0,"resultado":0},{"name":"Odontologia","receita":562.5,"custo":180,"despesa":1232.5,"resultado":-850},{"name":"Pessoal","receita":5912.2,"custo":665.96,"despesa":10621.99,"resultado":-5375.75},{"name":"Sem centro de custo","receita":0,"custo":0,"despesa":652.72,"resultado":-652.72},{"name":"Tecnologia","receita":2434.26,"custo":0,"despesa":1341.17,"resultado":1093.09}]},{"month":"2025-09","label":"Set/2025","items":[{"name":"Consultoria","receita":2750,"custo":43.2,"despesa":150,"resultado":2556.8},{"name":"Fotografia","receita":0,"custo":0,"despesa":0,"resultado":0},{"name":"Odontologia","receita":250,"custo":850.9,"despesa":1633.49,"resultado":-2234.39},{"name":"Pessoal","receita":5236.21,"custo":391.94,"despesa":8651.04,"resultado":-3806.77},{"name":"Sem centro de custo","receita":50,"custo":49.68,"despesa":1477.38,"resultado":-1477.06},{"name":"Tecnologia","receita":5380.49,"custo":750,"despesa":863.97,"resultado":3766.52}]},{"month":"2025-10","label":"Out/2025","items":[{"name":"Consultoria","receita":2365,"custo":15,"despesa":200,"resultado":2150},{"name":"Fotografia","receita":0,"custo":-214.18,"despesa":297.5,"resultado":-83.32},{"name":"Odontologia","receita":650,"custo":581.08,"despesa":1400,"resultado":-1331.08},{"name":"Pessoal","receita":7830.67,"custo":-170,"despesa":9561.89,"resultado":-1561.22},{"name":"Sem centro de custo","receita":0,"custo":-15.32,"despesa":703.53,"resultado":-688.21},{"name":"Tecnologia","receita":3492.86,"custo":50,"despesa":1144.44,"resultado":2298.42}]},{"month":"2025-11","label":"Nov/2025","items":[{"name":"Consultoria","receita":2415,"custo":201.4,"despesa":350,"resultado":1863.6},{"name":"Fotografia","receita":0,"custo":0,"despesa":394.33,"resultado":-394.33},{"name":"Odontologia","receita":600,"custo":338.84,"despesa":1604.35,"resultado":-1343.19},{"name":"Pessoal","receita":8074.55,"custo":240.52,"despesa":11703.39,"resultado":-3869.36},{"name":"Sem centro de custo","receita":0,"custo":-1353.68,"despesa":1706.03,"resultado":-352.35},{"name":"Tecnologia","receita":2351.81,"custo":-109,"despesa":1349.39,"resultado":1111.42}]},{"month":"2025-12","label":"Dez/2025","items":[{"name":"Consultoria","receita":2946.92,"custo":0,"despesa":500,"resultado":2446.92},{"name":"Fotografia","receita":350,"custo":0,"despesa":0,"resultado":350},{"name":"Odontologia","receita":645.83,"custo":197.64,"despesa":1509.89,"resultado":-1061.7},{"name":"Pessoal","receita":6430.35,"custo":312.99,"despesa":10001.56,"resultado":-3884.2},{"name":"Sem centro de custo","receita":0,"custo":-1.33,"despesa":1066.31,"resultado":-1064.98},{"name":"Tecnologia","receita":2650,"custo":119.59,"despesa":1236.3,"resultado":1294.11}]}]},"budgets":[{"category":"Alimentação/Mercado","limit":1000,"spent":1434.22,"sobra":0,"excedente":434.22},{"category":"Marketing","limit":300,"spent":0,"sobra":300,"excedente":0},{"category":"Restaurante","limit":400,"spent":890.8,"sobra":0,"excedente":490.8},{"category":"Vestuário","limit":150,"spent":352.42,"sobra":0,"excedente":202.42}],"extra":{"saldos":[{"accountId":"36c0a0b9-8cba-4741-a7e9-146b31db2c5a","accountName":"Permuta","balance":0,"isVirtual":false,"isReconcilable":true,"isPJBankVirtualAccountWaitingApprove":false,"bank":{"id":"ff659b0a-672b-4dc3-8ef1-fc6f2090f148","code":"-1","name":"Caixinha","color":"000000","scrapingEnabled":false,"automationEnabled":false},"pendingReconciliationCount":0},{"accountId":"449124a0-4dc7-424a-a15d-72143c2c343a","accountName":"Nubank - PJ","balance":18.11,"agency":"0001","accountNumber":"235466907","accountVerificationNumber":9,"isVirtual":false,"isReconcilable":true,"isPJBankVirtualAccountWaitingApprove":false,"bank":{"id":"8a88f674-614e-4343-a157-8b00d38579ca","code":"260","name":"Nubank","color":"000000","scrapingEnabled":false,"automationEnabled":false},"pendingReconciliationCount":7},{"accountId":"bf787cdd-a53f-4138-bec2-7f8e9405c09b","accountName":"Mercado Pago","balance":0.94,"agency":"0001","accountNumber":"1060220823","accountVerificationNumber":5,"isVirtual":false,"isReconcilable":true,"isPJBankVirtualAccountWaitingApprove":false,"bank":{"id":"590ecfd2-5312-441b-a85a-782da894adf0","code":"323","name":"Mercado Pago","color":"000000","scrapingEnabled":false,"automationEnabled":false},"pendingReconciliationCount":0},{"accountId":"a54943b6-9c97-4481-97bc-a5da16f26aa0","accountName":"Sicredi","balance":0.28,"agency":"0812","accountNumber":"00073728","accountVerificationNumber":1,"isVirtual":false,"isReconcilable":true,"isPJBankVirtualAccountWaitingApprove":false,"bank":{"id":"ec37a4af-26f0-4a33-939c-ffe7ae32a0e2","code":"748","name":"Sicredi","color":"000000","scrapingEnabled":false,"automationEnabled":false},"pendingReconciliationCount":0},{"accountId":"4f8dbbea-cf6c-415e-bb3c-b3f299b01004","accountName":"Nubank","balance":2.35,"agency":"0001","accountNumber":"61502563","accountVerificationNumber":1,"isVirtual":false,"isReconcilable":true,"isPJBankVirtualAccountWaitingApprove":false,"bank":{"id":"8a88f674-614e-4343-a157-8b00d38579ca","code":"260","name":"Nubank","color":"000000","scrapingEnabled":false,"automationEnabled":false},"pendingReconciliationCount":0}],"saldosAtivosCount":5,"totalSaldo":21.68,"tetoDeGastos":[{"categoryId":"d522cbf3-2f00-49c4-9a00-d8456d4124ce","nome":"Alimentação/Mercado","valor":1000},{"categoryId":"3aa74ec7-7a7c-44d5-b6b6-a4002dedb949","nome":"Marketing","valor":300},{"categoryId":"648f3336-f49e-4f89-a1eb-77448ee1fc46","nome":"Restaurante","valor":400},{"categoryId":"b0b75d22-b6a0-404d-b441-c3d67ec54e3c","nome":"Vestuário","valor":150}],"diario":{"despesasVariaveis":[{"nome":"Mercado","valor":1000},{"nome":"Restaurante","valor":400},{"nome":"Transporte","valor":600},{"nome":"Gestão Doméstica","valor":500},{"nome":"Saúde","valor":600},{"nome":"Lazer/Vestuário","valor":400}],"totalVariavel":3500,"gastoDiarioVariavel":112.9,"diasNoMes":31}},"debug":{"received_raw_all":185,"received_raw_unique":185,"received_raw_dupes":0,"paid_raw_all":854,"paid_raw_unique":854,"paid_raw_dupes":0,"categories_index_count":93,"op_selected_month":{"paid":{"included":4481.91,"ignored":0,"unknown":0,"noCategories":0,"notInTree":0},"received":{"included":25423.02,"ignored":0,"unknown":0,"noCategories":0,"notInTree":0}},"deltas":{"receita_realizado_menos_operacional":12169.92,"pagamento_realizado_menos_operacional":10231.05}}};
</script>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1 id="title">Relatório Financeiro Mensal</h1>
        <div class="sub" id="subtitle">
          Indicadores, comparativos, fluxo de caixa, previsões, centros de custo e teto de gastos.
        </div>
      </div>
      <div class="controls">
        <button class="btn" id="reload">Re-render</button>
      </div>
    </header>

    <div class="card cardCornerInfo">
      <div class="h2row"><h2>Indicadores mensais</h2><button class="infoBtn" data-info="kpis" aria-label="Entender Indicadores mensais">i</button></div>
      <div class="kpis" id="kpis"></div>
    </div>

    <div style="height:14px"></div>

    <div class="card cardCornerInfo">
        <div class="h2row"><h2>Alertas & Observações</h2><button class="infoBtn" data-info="alerts" aria-label="Entender Alertas & Observações">i</button></div>
        <div id="alerts" style="display:flex;flex-direction:column;gap:10px"></div>

        <div style="height:12px"></div>

        <h2>Teto de Gastos (detalhe)</h2>
        <div class="scroll" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Categoria</th>
                <th class="r">Limite</th>
                <th class="r">Gasto</th>
                <th class="r">Sobra</th>
                <th class="r">Excedente</th>
              </tr>
            </thead>
            <tbody id="tableBudget"></tbody>
          </table>
        </div>

        <div style="height:12px"></div>

        <h2>Centro de custo (mês selecionado)</h2>
        <div class="scroll" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Centro</th>
                <th class="r">Receita</th>
                <th class="r">Custo</th>
                <th class="r">Despesa</th>
                <th class="r">Resultado</th>
              </tr>
            </thead>
            <tbody id="tableCCMonth"></tbody>
          </table>
        </div>

        <div class="sub" style="margin-top:12px">Gerado em: <span id="generatedAt">—</span></div>
      </div>

    <div style="height:14px"></div>

    <div class="card">
        <h2>Gráficos</h2>

        <div class="chartsGrid">
          <div>
            <div class="pill pillRow"><div class="pillTitle"><span class="dot good"></span>Comparação de Realizado (últimos meses)</div><button class="infoBtn" type="button" data-info="realizado" aria-label="Entender Comparação de Realizado (últimos meses)">i</button></div>
            <div class="canvasWrap"><canvas id="chartRealizado"></canvas><div class="canvasPlaceholder" style="display:none"></div></div>
          </div>

          <div>
            <div class="pill pillRow"><div class="pillTitle"><span class="dot warn"></span>Comparação de Operação (últimos meses)</div><button class="infoBtn" type="button" data-info="operacao" aria-label="Entender Comparação de Operação (últimos meses)">i</button></div>
            <div class="canvasWrap large"><canvas id="chartOperacao"></canvas><div class="canvasPlaceholder" style="display:none"></div></div>
          </div>

          <div style="grid-column:1/-1">
            <div class="pill pillRow"><div class="pillTitle"><span class="dot bad"></span>Fluxo de Caixa Diário</div><button class="infoBtn" type="button" data-info="daily" aria-label="Entender Fluxo de Caixa Diário">i</button></div>
            <div class="canvasWrap tall"><canvas id="chartCashDaily"></canvas><div class="canvasPlaceholder" style="display:none"></div></div>
          </div>

          <div>
            <div class="pill pillRow"><div class="pillTitle"><span class="dot warn"></span>Previsão de Realização</div><button class="infoBtn" type="button" data-info="forecastReal" aria-label="Entender Previsão de Realização">i</button></div>
            <div class="canvasWrap"><canvas id="chartForecastRealizacao"></canvas><div class="canvasPlaceholder" style="display:none"></div></div>
          </div>

          <div>
            <div class="pill pillRow"><div class="pillTitle"><span class="dot good"></span>Previsão de Operação</div><button class="infoBtn" type="button" data-info="forecastOp" aria-label="Entender Previsão de Operação">i</button></div>
            <div class="canvasWrap"><canvas id="chartForecastOperacao"></canvas><div class="canvasPlaceholder" style="display:none"></div></div>
          </div>

          <div>
            <div class="pill pillRow"><div class="pillTitle"><span class="dot bad"></span>Resultado Operacional por Centro de Custo</div><button class="infoBtn" type="button" data-info="ccMonth" aria-label="Entender Resultado Operacional por Centro de Custo">i</button></div>
            <div class="canvasWrap"><canvas id="chartCCResultado"></canvas><div class="canvasPlaceholder" style="display:none"></div></div>
          </div>

          <div>
            <div class="pill pillRow"><div class="pillTitle"><span class="dot good"></span>Receita Operacional por Centro de Custo</div><button class="infoBtn" type="button" data-info="ccMonth" aria-label="Entender Receita Operacional por Centro de Custo">i</button></div>
            <div class="canvasWrap"><canvas id="chartCCReceita"></canvas><div class="canvasPlaceholder" style="display:none"></div></div>
          </div>

          <div>
            <div class="pill pillRow"><div class="pillTitle"><span class="dot warn"></span>Custo Operacional por Centro de Custo</div><button class="infoBtn" type="button" data-info="ccMonth" aria-label="Entender Custo Operacional por Centro de Custo">i</button></div>
            <div class="canvasWrap"><canvas id="chartCCCusto"></canvas><div class="canvasPlaceholder" style="display:none"></div></div>
          </div>

          <div>
            <div class="pill pillRow"><div class="pillTitle"><span class="dot bad"></span>Despesa Operacional por Centro de Custo</div><button class="infoBtn" type="button" data-info="ccMonth" aria-label="Entender Despesa Operacional por Centro de Custo">i</button></div>
            <div class="canvasWrap"><canvas id="chartCCDespesa"></canvas><div class="canvasPlaceholder" style="display:none"></div></div>
          </div>

          <div style="grid-column:1/-1">
            <div class="pill pillRow"><div class="pillTitle"><span class="dot good"></span>Centros de custo (evolução mensal)</div><button class="infoBtn" type="button" data-info="ccTimeline" aria-label="Entender Centros de custo (evolução mensal)">i</button></div>
            <div id="ccTimelines" class="ccTimelines"></div>
            <div class="sub">Cada centro de custo recebe seu próprio gráfico mensal (Receita, Custo, Despesa, Resultado).</div>
          </div>

          <div style="grid-column:1/-1">
            <div class="pill pillRow"><div class="pillTitle"><span class="dot bad"></span>Análise de Teto de Gastos (Categoria)</div><button class="infoBtn" type="button" data-info="budget" aria-label="Entender Análise de Teto de Gastos (Categoria)">i</button></div>
            <div class="canvasWrap tall"><canvas id="chartBudget"></canvas><div class="canvasPlaceholder" style="display:none"></div></div>
          </div>
        </div>
      </div>


  <script>
  // ===========================================================
  // Relatório injetado pelo n8n:
  // window.REPORT_DATA = {...}
  // ===========================================================
  let REPORT = null;
  REPORT = window.REPORT_DATA || null;

  const STATE = { selectedCC: "" };
  const chartsById = {};

  const SERIES_COLORS = {
    "Entradas": { line: "#2ee59d", fill: "rgba(46,229,157,.18)" },
    "Saídas": { line: "#ff5c79", fill: "rgba(255,92,121,.18)" },
    "Variação de Caixa": { line: "#77a7ff", fill: "rgba(119,167,255,.16)" },

    "Receita Operacional": { line: "#2ee59d", fill: "rgba(46,229,157,.18)" },
    "Custo Operacional": { line: "#f6c945", fill: "rgba(246,201,69,.20)" },
    "Despesa Operacional": { line: "#ff5c79", fill: "rgba(255,92,121,.18)" },
    "Resultado Operacional": { line: "#ff8da1", fill: "rgba(255,141,161,.18)" },
    "Margem de Contribuição": { line: "#77a7ff", fill: "rgba(119,167,255,.16)" },
    "Atividade de Investimento": { line: "#a78bfa", fill: "rgba(167,139,250,.16)" },
    "Atividade de Financiamento": { line: "#22d3ee", fill: "rgba(34,211,238,.16)" },

    "Contas Pagas": { line: "#ff5c79", fill: "rgba(255,92,121,.18)" },
    "Contas Recebidas": { line: "#2ee59d", fill: "rgba(46,229,157,.18)" },
    "A Pagar": { line: "#ff8b3d", fill: "rgba(255,139,61,.18)" },
    "A Receber": { line: "#4ade80", fill: "rgba(74,222,128,.18)" },

    "Limite": { line: "#77a7ff", fill: "rgba(119,167,255,.18)" },
    "Gasto": { line: "#ff5c79", fill: "rgba(255,92,121,.18)" }
  };

  function destroyChart(id){
    const c = chartsById[id];
    if (c && c.destroy) c.destroy();
    delete chartsById[id];
  }

  function setPlaceholder(canvasId, message){
    const el = document.getElementById(canvasId);
    if (!el) return;
    const wrap = el.parentElement;
    const box = wrap.querySelector(".canvasPlaceholder");
    if (!box) return;
    box.textContent = message;
    box.style.display = "flex";
  }
  function clearPlaceholder(canvasId){
    const el = document.getElementById(canvasId);
    if (!el) return;
    const wrap = el.parentElement;
    const box = wrap.querySelector(".canvasPlaceholder");
    if (!box) return;
    box.style.display = "none";
    box.textContent = "";
  }

  function safeNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
  function normLabel(v){ if (v == null) return "—"; const s = String(v).trim(); return s ? s : "—"; }

  function formatMoney(value, currency){
    const n = safeNum(value);
    try { return new Intl.NumberFormat("pt-BR", { style:"currency", currency }).format(n); }
    catch(e){ return `R$ ${n.toFixed(2)}`; }
  }
  function compactTick(value){
    const n = safeNum(value);
    const abs = Math.abs(n);
    const sign = n < 0 ? "-" : "";
    if (abs >= 1_000_000) return sign + Math.round(abs/1_000_000) + "M";
    if (abs >= 1_000) return sign + Math.round(abs/1_000) + "k";
    return sign + String(Math.round(abs));
  }

  function styleDataset(ds){
    const c = SERIES_COLORS[ds.label];
    if (!c) return ds;
    return { ...ds, borderColor: c.line, backgroundColor: c.fill };
  }

  function chartLine(id, labels, datasets, currency){
    const el = document.getElementById(id);
    if (!el) return null;
    destroyChart(id);
    clearPlaceholder(id);

    if (!window.Chart) { setPlaceholder(id, "Chart.js não carregou."); return null; }

    const chart = new Chart(el, {
      type: "line",
      data: { labels, datasets: datasets.map(ds => styleDataset({ ...ds, tension: 0.25, pointRadius: 2, borderWidth: 2 })) },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { grid: { color: "rgba(34,48,77,.20)" }, ticks: { color: "rgba(232,238,252,.75)" } },
          y: { grid: { color: "rgba(34,48,77,.35)" }, ticks: { color: "rgba(232,238,252,.75)", callback: (v)=> compactTick(v) } }
        },
        plugins: {
          legend: { position:"bottom", labels: { boxWidth: 12, padding: 12, usePointStyle: true, color: "rgba(232,238,252,.80)" } },
          tooltip: { callbacks: { label: (ctx)=> {
            const value = safeNum(ctx.raw);
            let out = `${ctx.dataset.label}: ${formatMoney(value, currency)}`;

            const ds = ctx.dataset || {};
            if (ds.showPercent){
              const arr = Array.isArray(ds.data) ? ds.data : [];
              const total = arr.reduce((a,v)=> a + Math.abs(safeNum(v)), 0);
              const pct = total ? (Math.abs(value) / total) * 100 : 0;
              out += ` (${pct.toFixed(1)}%)`;
            }
            if (ds.relativeToDatasetLabel){
              const ref = (ctx.chart?.data?.datasets || []).find(d => d.label === ds.relativeToDatasetLabel);
              const refVal = safeNum(ref?.data?.[ctx.dataIndex]);
              const pct = refVal ? (value / refVal) * 100 : 0;
              out += ` (${pct.toFixed(1)}%)`;
            }
            return out;
          } } }
        }
      }
    });

    chartsById[id] = chart;
    return chart;
  }

  function chartBar(id, labels, datasets, currency, horizontal=false, onClick=null){
    const el = document.getElementById(id);
    if (!el) return null;
    destroyChart(id);
    clearPlaceholder(id);

    if (!window.Chart) { setPlaceholder(id, "Chart.js não carregou."); return null; }

    const chart = new Chart(el, {
      type: "bar",
      data: { labels, datasets: datasets.map(ds => styleDataset({ ...ds, borderWidth: 1, minBarLength: 2 })) },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: horizontal ? "y" : "x",
        onClick: onClick || undefined,
        scales: {
          x: horizontal
            ? { grid: { color: "rgba(34,48,77,.35)" }, ticks: { color: "rgba(232,238,252,.75)", callback: (v)=> compactTick(v) } }
            : { grid: { color: "rgba(34,48,77,.20)" }, ticks: { color: "rgba(232,238,252,.75)" } },
          y: horizontal
            ? { grid: { color: "rgba(34,48,77,.20)" }, ticks: { color: "rgba(232,238,252,.75)" } }
            : { grid: { color: "rgba(34,48,77,.35)" }, ticks: { color: "rgba(232,238,252,.75)", callback: (v)=> compactTick(v) } }
        },
        plugins: {
          legend: { position:"bottom", labels: { boxWidth: 12, padding: 12, usePointStyle: true, color: "rgba(232,238,252,.80)" } },
          tooltip: { callbacks: { label: (ctx)=> {
            const value = safeNum(ctx.raw);
            let out = `${ctx.dataset.label}: ${formatMoney(value, currency)}`;

            const ds = ctx.dataset || {};
            if (ds.showPercent){
              const arr = Array.isArray(ds.data) ? ds.data : [];
              const total = arr.reduce((a,v)=> a + Math.abs(safeNum(v)), 0);
              const pct = total ? (Math.abs(value) / total) * 100 : 0;
              out += ` (${pct.toFixed(1)}%)`;
            }
            if (ds.relativeToDatasetLabel){
              const ref = (ctx.chart?.data?.datasets || []).find(d => d.label === ds.relativeToDatasetLabel);
              const refVal = safeNum(ref?.data?.[ctx.dataIndex]);
              const pct = refVal ? (value / refVal) * 100 : 0;
              out += ` (${pct.toFixed(1)}%)`;
            }
            return out;
          } } }
        }
      }
    });

    chartsById[id] = chart;
    return chart;
  }

  // ----------------- normalização de shapes ------------------
  function normalizeComparisonRealizado(raw){
    if (Array.isArray(raw)){
      const labels = raw.map(x => normLabel(x?.label ?? x?.month ?? x?.monthKey ?? x?.competencia));
      return {
        labels,
        contasPagas: raw.map(x => safeNum(x?.contasPagas ?? x?.paid ?? x?.saidas ?? x?.out)),
        contasRecebidas: raw.map(x => safeNum(x?.contasRecebidas ?? x?.received ?? x?.entradas ?? x?.in)),
        variacaoCaixa: raw.map(x => safeNum(x?.variacaoCaixa ?? x?.variacao ?? x?.delta))
      };
    }
    if (raw && Array.isArray(raw.labels)) return raw;
    return { labels: [], contasPagas: [], contasRecebidas: [], variacaoCaixa: [] };
  }

  function normalizeComparisonOperacao(raw){
    if (Array.isArray(raw)){
      const labels = raw.map(x => normLabel(x?.label ?? x?.month ?? x?.monthKey ?? x?.competencia));
      return {
        labels,
        receitaOperacional: raw.map(x => safeNum(x?.receitaOperacional ?? x?.receita)),
        custoOperacional: raw.map(x => safeNum(x?.custoOperacional ?? x?.custo)),
        despesaOperacional: raw.map(x => safeNum(x?.despesaOperacional ?? x?.despesa)),
        margemContribuicao: raw.map(x => safeNum(x?.margemContribuicao ?? x?.margem)),
        atividadeInvestimento: raw.map(x => safeNum(x?.atividadeInvestimento ?? x?.E ?? x?.investimento)),
        atividadeFinanciamento: raw.map(x => safeNum(x?.atividadeFinanciamento ?? x?.F ?? x?.financiamento))
      };
    }
    if (raw && Array.isArray(raw.labels)) return raw;
    return { labels: [], receitaOperacional: [], custoOperacional: [], despesaOperacional: [], margemContribuicao: [], atividadeInvestimento: [], atividadeFinanciamento: [] };
  }

  function normalizeCashDaily(raw){
    if (Array.isArray(raw)){
      const labels = raw.map(x => normLabel(x?.label ?? x?.day ?? x?.date ?? x?.data));
      return {
        labels,
        entradas: raw.map(x => safeNum(x?.entradas ?? x?.in)),
        saidas: raw.map(x => safeNum(x?.saidas ?? x?.out)),
        variacao: raw.map(x => safeNum(x?.variacao ?? x?.delta))
      };
    }
    if (raw && Array.isArray(raw.labels)) return raw;
    return { labels: [], entradas: [], saidas: [], variacao: [] };
  }

  function fixCCName(name){
    const s = (name ?? "").toString().trim();
    const low = s.toLowerCase();
    if (!s || s === "—" || s === "-" || s === "--") return "Sem centro de custo";
    if (low === "centro de custo") return "Sem centro de custo";
    return s;
  }

  function mergeCCRows(rows){
    const map = new Map();
    for (const r of (Array.isArray(rows) ? rows : [])){
      const name = fixCCName(r?.name);
      const prev = map.get(name) || { name, receita:0, custo:0, despesa:0, resultado:0 };
      prev.receita += safeNum(r?.receita);
      prev.custo += safeNum(r?.custo);
      prev.despesa += safeNum(r?.despesa);
      prev.resultado += safeNum(r?.resultado);
      map.set(name, prev);
    }
    return Array.from(map.values());
  }

  function normalizeCostCenters(raw){
    const cc = raw || {};
    const monthItemsRaw =
      (Array.isArray(cc?.selectedMonth?.items) ? cc.selectedMonth.items :
       (Array.isArray(cc?.monthBreakdown) ? cc.monthBreakdown :
        (Array.isArray(cc?.monthBreakdown?.items) ? cc.monthBreakdown.items : [])));

    const monthItems = mergeCCRows(monthItemsRaw);
    const monthlyRaw = Array.isArray(cc?.monthly) ? cc.monthly : [];
    const monthly = monthlyRaw.map(m => ({ ...m, items: mergeCCRows(Array.isArray(m?.items) ? m.items : []) }));

    return { ...cc, selectedMonth: { ...(cc?.selectedMonth || {}), items: monthItems }, monthly };
  }

  function normalizeReport(data){
    const d = data || {};
    return {
      ...d,
      comparisonRealizado: normalizeComparisonRealizado(d?.comparisonRealizado),
      comparisonOperacao: normalizeComparisonOperacao(d?.comparisonOperacao),
      cashflowDaily: normalizeCashDaily(d?.cashflowDaily),
      costCenters: normalizeCostCenters(d?.costCenters)
    };
  }

  // ----------------- renderização ------------------
  function renderKpis(data){
    const k = data?.kpis || {};
    const currency = data?.meta?.currency || "BRL";

    const items = [
      { name: "Contas Pagas", value: formatMoney(k.contasPagas, currency), hint: "Saídas" },
      { name: "Contas Recebidas", value: formatMoney(k.contasRecebidas, currency), hint: "Entradas" },
      { name: "Variação de Caixa (D+E+F)", value: formatMoney((k.variacaoCaixaDEF ?? k.variacaoCaixa), currency), hint: "Saldo" },

      { name: "Receitas Operacionais (A)", value: formatMoney(k.receitaOperacional, currency), hint: "Receita" },
      { name: "Custos Operacionais (B)", value: formatMoney(k.custoOperacional, currency), hint: "Custo" },
      { name: "Despesas Operacionais e Outras Receitas (C)", value: formatMoney(k.despesaOperacional, currency), hint: "Despesa" },

      { name: "Resultado Operacional (D)", value: formatMoney(k.resultadoOperacional, currency), hint: "Resultado" },
      { name: "Margem de Contribuição (A − B)", value: formatMoney(k.margemContribuicao, currency), hint: "Margem" },

      { name: "Atividade de Investimento (E)", value: formatMoney(k.atividadeInvestimento, currency), hint: "Invest." },
      { name: "Atividade de Financiamento (F)", value: formatMoney(k.atividadeFinanciamento, currency), hint: "Financ." }
    ];

    document.getElementById("kpis").innerHTML = items.map(x => `
      <div class="kpi">
        <div class="name">${x.name}</div>
        <div class="value">${x.value}</div>
        <div class="hint">${x.hint}</div>
      </div>
    `).join("");
  }

  function renderAlerts(data){
    const k = data?.kpis || {};
    const currency = data?.meta?.currency || "BRL";
    const budgets = Array.isArray(data?.budgets) ? data.budgets : [];
    const exceeded = budgets
      .filter(b => safeNum(b.excedente) > 0)
      .sort((a,b)=> safeNum(b.excedente) - safeNum(a.excedente))
      .slice(0,4);

    const rows = [];
    rows.push({
      level: safeNum(k.resultadoOperacional) < 0 ? "bad" : "good",
      title: "Resultado Operacional",
      subtitle: `Resultado do mês: ${formatMoney(k.resultadoOperacional, currency)}`
    });
    rows.push({
      level: safeNum(k.variacaoCaixaDEF ?? k.variacaoCaixa) < 0 ? "bad" : "good",
      title: "Variação de Caixa (D+E+F)",
      subtitle: `Variação do mês: ${formatMoney((k.variacaoCaixaDEF ?? k.variacaoCaixa), currency)}`
    });
    if (exceeded.length){
      rows.push({
        level: "bad",
        title: "Categorias acima do teto",
        subtitle: exceeded.map(x => `${x.category} (${formatMoney(x.excedente, currency)})`).join(" · ")
      });
    }
    const fo = data?.forecastOperacao;
    if (fo && (safeNum(fo.variacaoCaixaDEF) !== 0 || safeNum(fo.resultadoOperacional) !== 0)){
      rows.push({
        level: "warn",
        title: "Previsão (D+E+F)",
        subtitle: `Previsto: ${formatMoney(fo.variacaoCaixaDEF, currency)} (Resultado + E + F)`
      });
    }

    document.getElementById("alerts").innerHTML = rows.map(r => `
      <div class="alert" style="border-color: ${r.level==="bad" ? "rgba(255,92,121,.35)" : r.level==="warn" ? "rgba(246,201,69,.35)" : "rgba(46,229,157,.30)"}">
        <div class="t">${r.title}</div>
        <div class="s">${r.subtitle}</div>
      </div>
    `).join("");
  }

  function renderBudget(data){
    const currency = data?.meta?.currency || "BRL";
    const budgets = Array.isArray(data?.budgets) ? data.budgets : [];

    if (!budgets.length){
      setPlaceholder("chartBudget", "Sem dados de teto de gastos.");
      document.getElementById("tableBudget").innerHTML = `<tr><td colspan="5" class="muted">Sem dados.</td></tr>`;
      return;
    }

    const rows = budgets
      .slice()
      .sort((a,b)=> Math.max(safeNum(b.limit), safeNum(b.spent)) - Math.max(safeNum(a.limit), safeNum(a.spent)));

    chartBar(
      "chartBudget",
      rows.map(x => x.category ?? "—"),
      [
        { label: "Limite", data: rows.map(x => safeNum(x.limit)) },
        { label: "Gasto", data: rows.map(x => safeNum(x.spent)), relativeToDatasetLabel: "Limite" }
      ],
      currency,
      true
    );

    document.getElementById("tableBudget").innerHTML = budgets.map(b => `
      <tr>
        <td>${b.category ?? "—"}</td>
        <td class="r">${formatMoney(b.limit, currency)}</td>
        <td class="r">${formatMoney(b.spent, currency)}</td>
        <td class="r">${formatMoney(b.sobra, currency)}</td>
        <td class="r">${formatMoney(b.excedente, currency)}</td>
      </tr>
    `).join("");
  }

  function pickDefaultCC(ccItems){
    const items = Array.isArray(ccItems) ? ccItems : [];
    if (!items.length) return "";
    const sorted = items.slice().sort((a,b)=> safeNum(b.receita) - safeNum(a.receita));
    const best = sorted.find(x => (x.name || "").toLowerCase() !== "sem centro de custo") || sorted[0];
    return best?.name || "";
  }

  function renderCostCenters(data){
    const currency = data?.meta?.currency || "BRL";
    const cc = normalizeCostCenters(data?.costCenters);
    const monthItems = Array.isArray(cc?.selectedMonth?.items) ? cc.selectedMonth.items : [];
    const monthly = Array.isArray(cc?.monthly) ? cc.monthly : [];

    if (!monthItems.length){
      setPlaceholder("chartCCResultado", "Sem dados de centro de custo (mês).");
      setPlaceholder("chartCCReceita", "Sem dados de centro de custo (mês).");
      setPlaceholder("chartCCCusto", "Sem dados de centro de custo (mês).");
      setPlaceholder("chartCCDespesa", "Sem dados de centro de custo (mês).");
            document.getElementById("tableCCMonth").innerHTML = `<tr><td colspan="5" class="muted">Sem dados.</td></tr>`;
      return;
    }

    document.getElementById("tableCCMonth").innerHTML = monthItems.map(r => `
      <tr>
        <td>${r.name ?? "—"}</td>
        <td class="r">${formatMoney(r.receita, currency)}</td>
        <td class="r">${formatMoney(r.custo, currency)}</td>
        <td class="r">${formatMoney(r.despesa, currency)}</td>
        <td class="r">${formatMoney(r.resultado, currency)}</td>
      </tr>
    `).join("");

    // Gráficos do mês (barras) — sempre por "centro de custo"
    const labels = monthItems.map(x => x.name ?? "—");

    chartBar("chartCCResultado", labels, [{ label:"Resultado Operacional", data: monthItems.map(x=> safeNum(x.resultado)) }], currency, true);
    chartBar("chartCCReceita", labels, [{ label:"Receita Operacional", data: monthItems.map(x=> safeNum(x.receita)) }], currency, true);
    chartBar("chartCCCusto", labels, [{ label:"Custo Operacional", data: monthItems.map(x=> safeNum(x.custo)), showPercent: true }], currency, true);
    chartBar("chartCCDespesa", labels, [{ label:"Despesa Operacional", data: monthItems.map(x=> safeNum(x.despesa)), showPercent: true }], currency, true);

    // Evolução mensal — um gráfico por centro de custo
    const container = document.getElementById("ccTimelines");
    if (!container){
      return;
    }
    container.innerHTML = "";

    if (!monthly.length){
      container.innerHTML = `<div class="muted">Sem dados de centros de custo (mensal).</div>`;
      return;
    }

    const ccNames = monthItems
      .map(x => (x.name ?? "").toString())
      .map(x => x.trim())
      .filter(Boolean)
      .filter(x => x.toLowerCase() !== "sem centro de custo");

    const labelsM = monthly.map(m => m.label ?? m.month ?? "—");

    for (let i = 0; i < ccNames.length; i++){
      const ccName = ccNames[i];

      const card = document.createElement("div");
      card.className = "ccCard";

      const title = document.createElement("div");
      title.className = "ccTitle";
      title.textContent = ccName;

      const wrap = document.createElement("div");
      wrap.className = "canvasWrap tall";

      const canvas = document.createElement("canvas");
      const canvasId = `ccTL_${i}`;
      canvas.id = canvasId;

      const ph = document.createElement("div");
      ph.className = "canvasPlaceholder";
      ph.style.display = "none";

      wrap.appendChild(canvas);
      wrap.appendChild(ph);
      card.appendChild(title);
      card.appendChild(wrap);
      container.appendChild(card);

      const series = monthly.map(m => (Array.isArray(m.items) ? m.items : []).find(it => (it.name ?? "") === ccName) || null);
      const any = series.some(x => x && (safeNum(x.receita)||safeNum(x.custo)||safeNum(x.despesa)||safeNum(x.resultado)));
      if (!any){
        setPlaceholder(canvasId, "Sem dados para este centro de custo.");
        continue;
      }

      chartLine(canvasId, labelsM, [
        { label:"Receita Operacional", data: series.map(x=> safeNum(x?.receita)) },
        { label:"Custo Operacional", data: series.map(x=> safeNum(x?.custo)) },
        { label:"Despesa Operacional", data: series.map(x=> safeNum(x?.despesa)) },
        { label:"Resultado Operacional", data: series.map(x=> safeNum(x?.resultado)) }
      ], currency);
    }

  }

  function renderComparisons(data){
    const currency = data?.meta?.currency || "BRL";

    const r = normalizeComparisonRealizado(data?.comparisonRealizado);
    if (Array.isArray(r.labels) && r.labels.length){
      chartLine("chartRealizado", r.labels, [
        { label:"Contas Pagas", data: r.contasPagas || [] },
        { label:"Contas Recebidas", data: r.contasRecebidas || [] },
        { label:"Variação de Caixa", data: r.variacaoCaixa || [] }
      ], currency);
    } else {
      setPlaceholder("chartRealizado", "Sem dados de comparação (realizado).");
    }

    const o = normalizeComparisonOperacao(data?.comparisonOperacao);
    if (Array.isArray(o.labels) && o.labels.length){
      chartLine("chartOperacao", o.labels, [
        { label:"Receita Operacional", data: o.receitaOperacional || [] },
        { label:"Custo Operacional", data: o.custoOperacional || [] },
        { label:"Despesa Operacional", data: o.despesaOperacional || [] },
        { label:"Margem de Contribuição", data: o.margemContribuicao || [] },
        { label:"Atividade de Investimento", data: o.atividadeInvestimento || [] },
        { label:"Atividade de Financiamento", data: o.atividadeFinanciamento || [] }
      ], currency);
    } else {
      setPlaceholder("chartOperacao", "Sem dados de comparação (operação).");
    }
  }

  function renderCashDaily(data){
    const currency = data?.meta?.currency || "BRL";
    const cf = normalizeCashDaily(data?.cashflowDaily);
    if (Array.isArray(cf.labels) && cf.labels.length){
      chartLine("chartCashDaily", cf.labels, [
        { label:"Entradas", data: cf.entradas || [] },
        { label:"Saídas", data: cf.saidas || [] },
        { label:"Variação de Caixa", data: cf.variacao || [] }
      ], currency);
    } else {
      setPlaceholder("chartCashDaily", "Sem dados de fluxo diário.");
    }
  }

  function renderForecasts(data){
    const currency = data?.meta?.currency || "BRL";

    const fr = data?.forecastRealizacao;
    if (fr && (safeNum(fr.contasAPagar) || safeNum(fr.contasAReceber) || safeNum(fr.variacaoCaixa))){
      chartBar("chartForecastRealizacao", ["Previsão"], [
        { label:"A Receber", data: [safeNum(fr.contasAReceber)] },
        { label:"A Pagar", data: [safeNum(fr.contasAPagar)] },
        { label:"Variação de Caixa", data: [safeNum(fr.variacaoCaixa)] }
      ], currency, false);
    } else {
      setPlaceholder("chartForecastRealizacao", "Sem dados de previsão (realização).");
    }

    const fo = data?.forecastOperacao;
    if (fo && (
      safeNum(fo.receitaOperacional) ||
      safeNum(fo.custoOperacional) ||
      safeNum(fo.margemContribuicao) ||
      safeNum(fo.despesaOperacional) ||
      safeNum(fo.atividadeInvestimento) ||
      safeNum(fo.atividadeFinanciamento) ||
      safeNum(fo.resultadoOperacional)
    )){
      chartBar("chartForecastOperacao", ["Previsão"], [
        { label:"Receita Operacional", data: [safeNum(fo.receitaOperacional)] },
        { label:"Custo Operacional", data: [safeNum(fo.custoOperacional)] },
        { label:"Margem de Contribuição", data: [safeNum(fo.margemContribuicao)] },
        { label:"Despesa Operacional", data: [safeNum(fo.despesaOperacional)] },
        { label:"Atividade de Investimento", data: [safeNum(fo.atividadeInvestimento)] },
        { label:"Atividade de Financiamento", data: [safeNum(fo.atividadeFinanciamento)] },
        { label:"Resultado Operacional", data: [safeNum(fo.resultadoOperacional)] }
      ], currency, false);
    } else {
      setPlaceholder("chartForecastOperacao", "Sem dados de previsão (operação).");
    }
  }

  function render(){
    const DATA = normalizeReport(REPORT);
    const now = new Date();
    document.getElementById("generatedAt").textContent = now.toLocaleString("pt-BR");

    if (!REPORT){
      document.getElementById("kpis").innerHTML = `<div class="kpi" style="grid-column:1/-1"><div class="name">Sem dados</div><div class="value">—</div><div class="hint">Injete REPORT_DATA no HTML.</div></div>`;
      return;
    }

    const company = REPORT?.meta?.companyName ? ` — ${REPORT.meta.companyName}` : "";
    const monthLabel = REPORT?.meta?.monthLabel ? ` (${REPORT.meta.monthLabel})` : "";
    document.getElementById("title").textContent = `Relatório Financeiro Mensal${company}${monthLabel}`;

    renderKpis(DATA);
    renderComparisons(DATA);
    renderCashDaily(DATA);
    renderForecasts(DATA);
    renderCostCenters(DATA);
    renderBudget(DATA);
    renderAlerts(DATA);
  }

  document.getElementById("reload").addEventListener("click", () => render());
  render();
  

// ===== INFO POPUP (explicações para clientes) =====
const INFO_CONTENT = {"realizado": "<b>Comparação de Realizado</b><br>\nMostra o que realmente aconteceu nos últimos meses.<br>\n• <b>Contas Pagas</b>: total pago (saídas) no mês.<br>\n• <b>Contas Recebidas</b>: total recebido (entradas) no mês.<br>\n• <b>Variação de Caixa</b>: Recebidas − Pagas (saldo do mês).", "operacao": "<b>Comparação de Operação</b><br>\nMostra o desempenho operacional mensal (DRE simplificado).<br>\n• <b>Receita Operacional</b>: entradas ligadas ao negócio (vendas/serviços).<br>\n• <b>Custo Operacional</b>: custos diretamente ligados à entrega (ex.: insumos/produção).<br>\n• <b>Despesa Operacional</b>: despesas para manter a operação (ex.: aluguel, marketing, pessoal administrativo).<br>\n• <b>Margem de Contribuição</b>: Receita − Custo (quanto sobra para pagar despesas e gerar resultado).<br>\n• <b>Atividade de Investimento</b>: compras/vendas de ativos e investimentos (fluxo geralmente não recorrente).<br>\n• <b>Atividade de Financiamento</b>: empréstimos, aportes, retirada/distribuição, etc.<br>\n• <b>Resultado Operacional</b>: Receita − Custo − Despesa.", "daily": "<b>Fluxo de Caixa Diário</b><br>\nEvolução diária do caixa dentro do mês.<br>\n• <b>Entradas</b>: valores recebidos no dia.<br>\n• <b>Saídas</b>: valores pagos no dia.<br>\n• <b>Variação de Caixa</b>: Entradas − Saídas (saldo do dia).", "forecastReal": "<b>Previsão de Realização</b><br>\nProjeção do caixa com base no que está <b>em aberto</b> (a vencer) para o período de previsão.<br>\n• <b>A Receber</b>: títulos/contas a receber em aberto.<br>\n• <b>A Pagar</b>: títulos/contas a pagar em aberto.<br>\n• <b>Variação de Caixa</b>: A Receber − A Pagar (projeção).", "forecastOp": "<b>Previsão de Operação</b><br>\nMostra como a operação tende a ficar no próximo mês, considerando o que está <b>em aberto</b> (a receber / a pagar) classificado por tipo.<ul>\n<li><b>Receita Operacional</b>: valores a receber ligados à atividade principal do negócio.</li>\n<li><b>Custo Operacional</b>: gastos diretamente ligados à entrega do serviço/produto (ex.: insumos, execução).</li>\n<li><b>Margem de Contribuição</b>: <b>Receita − Custo</b>. Indica quanto “sobra” da operação antes das despesas.</li>\n<li><b>Despesa Operacional</b>: gastos para manter a operação (ex.: administrativo, marketing, etc.).</li>\n<li><b>Atividade de Investimento</b>: entradas/saídas por compra/venda de bens, investimentos e similares.</li>\n<li><b>Atividade de Financiamento</b>: entradas/saídas por empréstimos, aportes, distribuição, etc.</li>\n<li><b>Resultado Operacional</b>: <b>Receita − Custo − Despesa</b>.</li>\n</ul>", "ccMonth": "<b>Operação por Centro de Custo</b><br>\nQuebra do mês por centro de custo (área/projeto).<br>\n• <b>Receita/Custo/Despesa</b>: total do mês por centro.<br>\n• <b>Resultado</b>: Receita − Custo − Despesa.<br>\nUse para ver quais áreas geram (ou consomem) resultado.", "ccTimeline": "<b>Evolução mensal por Centro de Custo</b><br>\nUm gráfico por centro de custo mostrando a evolução mensal de: Receita, Custo, Despesa e Resultado.<br>\nAjuda a identificar tendência (melhora/piora) por área.", "budget": "<b>Teto de Gastos</b><br>\nCompara o <b>Limite</b> planejado vs <b>Gasto</b> realizado por categoria.<br>\n• <b>Sobra</b>: quanto ainda cabe no limite.<br>\n• <b>Excedente</b>: quanto passou do limite.", "kpis": "<b>Indicadores mensais</b><br>\nResumo dos principais números do mês selecionado.<ul>\n<li><b>Contas Pagas</b>: total de saídas efetivamente pagas no mês.</li>\n<li><b>Contas Recebidas</b>: total de entradas efetivamente recebidas no mês.</li>\n<li><b>Variação de Caixa</b>: <b>Recebidas − Pagas</b> (saldo do mês).</li>\n<li><b>Receita Operacional</b>: receitas classificadas como operação do negócio.</li>\n<li><b>Custo Operacional</b>: custos diretamente ligados à entrega.</li>\n<li><b>Despesas Operacionais e Outras Receitas</b>: despesas para manter o negócio + outras receitas classificadas fora da operação principal.</li>\n<li><b>Resultado Operacional</b>: <b>Receita Operacional − Custo − Despesa</b>.</li>\n<li><b>Margem de Contribuição</b>: <b>Receita Operacional − Custo</b>.</li>\n<li><b>Atividade de Investimento / Financiamento</b>: movimentações fora da operação (investimentos e financiamentos).</li>\n</ul>", "alerts": "<b>Alertas & Observações</b><br>\nPontos de atenção gerados automaticamente a partir dos dados do mês.<ul>\n<li><b>Resultado Operacional</b>: indica se a operação fechou positiva/negativa no mês.</li>\n<li><b>Variação de Caixa (D+E+F)</b>: saldo do mês considerando operação + investimento + financiamento.</li>\n<li><b>Categorias acima do teto</b>: categorias que ultrapassaram o limite definido no “Teto de Gastos”.</li>\n<li><b>Previsão (D+E+F)</b>: projeção do próximo mês com base no que está em aberto (resultado + E + F).</li>\n</ul>"};

(function(){
  let back = null;
  let titleEl = null;
  let bodyEl = null;
  let btnClose = null;
  function ensureInfoModalRefs(){
    back = back || document.getElementById("infoModalBack");
    titleEl = titleEl || document.getElementById("infoModalTitle");
    bodyEl = bodyEl || document.getElementById("infoModalBody");
    btnClose = btnClose || document.getElementById("infoModalClose");
  }
function openInfo(key, fallbackTitle){
    ensureInfoModalRefs();
    if (!back || !titleEl || !bodyEl) return;
    const html = INFO_CONTENT[key] || "Sem explicação cadastrada.";
    titleEl.textContent = fallbackTitle || "Entenda";
    bodyEl.innerHTML = html;
    back.style.display = "flex";
    back.setAttribute("aria-hidden","false");
  }
  function closeInfo(){
    ensureInfoModalRefs();
    if (!back) return;
    back.style.display = "none";
    back.setAttribute("aria-hidden","true");
  }

  document.addEventListener("click", (e)=>{
    const btn = e.target.closest && e.target.closest(".infoBtn");
    if (btn){
      const key = btn.getAttribute("data-info");
      const t = btn.closest(".pill")?.querySelector(".pillTitle")?.textContent?.trim() || btn.closest(".h2row")?.querySelector("h2")?.textContent?.trim();
      openInfo(key, t);
      return;
    }
    const x = e.target.closest && e.target.closest("#infoModalClose");
    if (x){ closeInfo(); return; }
    if (e.target === back) closeInfo();
  });
  ensureInfoModalRefs();
  btnClose && btnClose.addEventListener("click", closeInfo);
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeInfo(); });
})();
</script>

  <div id="infoModalBack" class="modalBack" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHd">
        <div id="infoModalTitle" class="t">Entenda</div>
        <button id="infoModalClose" class="modalClose" type="button" aria-label="Fechar">✕</button>
      </div>
      <div id="infoModalBody" class="modalBd"></div>
    </div>
  </div>

</body>
</html>
